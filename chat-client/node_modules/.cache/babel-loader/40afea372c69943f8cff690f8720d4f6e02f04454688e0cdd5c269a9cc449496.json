{"ast":null,"code":"var _SocketService;\nimport { io } from 'socket.io-client';\nimport { useNavigate } from 'react-router-dom';\nclass SocketService {\n  constructor() {\n    this.socket = null;\n  }\n  static getInstance() {\n    if (!SocketService.instance) {\n      SocketService.instance = new SocketService();\n    }\n    return SocketService.instance;\n  }\n  initializeSocket(token) {\n    return new Promise((resolve, reject) => {\n      var _this$socket,\n        _s = $RefreshSig$();\n      if ((_this$socket = this.socket) !== null && _this$socket !== void 0 && _this$socket.connected) return resolve(this.socket);\n      const cleanToken = token.replace('Bearer ', '');\n      const userId = localStorage.getItem('userId');\n      if (!userId) {\n        return reject(new Error('Missing userId in localStorage'));\n      }\n      if (!this.isTokenValid(cleanToken)) {\n        return reject(new Error('Invalid or expired token'));\n      }\n      this.socket = io('http://localhost:8080', {\n        path: '/socket.io',\n        auth: {\n          token: cleanToken\n        },\n        transports: ['websocket'],\n        reconnectionAttempts: 5,\n        reconnectionDelay: 2000,\n        query: {\n          userId,\n          token: cleanToken\n        },\n        withCredentials: true\n      });\n      this.socket.on('connect', () => {\n        console.log(\"WebSocket connected\");\n        resolve(this.socket);\n      });\n      this.socket.on('disconnect', () => {\n        console.log('Disconnected. Retrying...');\n        setTimeout(() => this.initializeSocket(token), 5000); // Retry after 5 seconds\n      });\n      _s(this.socket.on('connect_error', _s(err => {\n        _s();\n        console.error('Connection error:', err.message);\n        if (err.message === 'Unauthorized') {\n          localStorage.removeItem('token');\n          const navigate = useNavigate();\n          navigate('/login');\n        }\n        reject(err);\n      }, \"CzcTeTziyjMsSrAVmHuCCb6+Bfg=\", false, function () {\n        return [useNavigate];\n      })), \"CzcTeTziyjMsSrAVmHuCCb6+Bfg=\", false, function () {\n        return [useNavigate];\n      });\n    });\n  }\n  onConnectionStatusChange(callback) {\n    if (!this.socket) return;\n    this.socket.on('connect', () => callback('connected'));\n    this.socket.on('disconnect', () => callback('disconnected'));\n    this.socket.on('connect_error', () => callback('error'));\n    this.socket.on('reconnect_failed', () => callback('error'));\n  }\n  disconnect() {\n    if (this.socket) {\n      this.socket.disconnect();\n      this.socket = null;\n      console.log(\"üîå WebSocket disconnected\");\n    }\n  }\n  isTokenValid(token) {\n    try {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      return payload.exp * 1000 > Date.now(); // Check if token is expired\n    } catch {\n      return false;\n    }\n  }\n}\n_SocketService = SocketService;\nSocketService.instance = void 0;\nexport const socketService = SocketService.getInstance();\nconst connectSocket = async () => {\n  let token = localStorage.getItem('token');\n  if (!token || !socketService.isTokenValid(token)) {\n    token = await refreshToken();\n    async function refreshToken() {\n      // Example implementation of refreshToken\n      try {\n        const response = await fetch('http://localhost:8080/api/refresh-token', {\n          method: 'POST',\n          credentials: 'include'\n        });\n        if (!response.ok) throw new Error('Failed to refresh token');\n        const data = await response.json();\n        localStorage.setItem('token', data.token);\n        return data.token;\n      } catch (error) {\n        console.error('Error refreshing token:', error);\n        return null;\n      }\n    }\n    if (!token) {\n      navigate('/login');\n      return;\n    }\n  }\n  try {\n    const socket = await socketService.initializeSocket(token);\n    socketService.onConnectionStatusChange(setConnectionStatus);\n  } catch (error) {\n    console.error('Socket connection error:', error);\n    setConnectionStatus('error');\n  }\n};\nfunction setConnectionStatus(status) {\n  const statusElement = document.getElementById('connection-status');\n  if (!statusElement) {\n    console.warn('Connection status element not found in the DOM.');\n    return;\n  }\n  switch (status) {\n    case 'connected':\n      statusElement.textContent = 'üü¢ Connected';\n      statusElement.style.color = 'green';\n      break;\n    case 'disconnected':\n      statusElement.textContent = 'üî¥ Disconnected';\n      statusElement.style.color = 'red';\n      break;\n    case 'error':\n      statusElement.textContent = '‚ö†Ô∏è Connection Error';\n      statusElement.style.color = 'orange';\n      break;\n  }\n}","map":{"version":3,"names":["io","useNavigate","SocketService","constructor","socket","getInstance","instance","initializeSocket","token","Promise","resolve","reject","_this$socket","_s","$RefreshSig$","connected","cleanToken","replace","userId","localStorage","getItem","Error","isTokenValid","path","auth","transports","reconnectionAttempts","reconnectionDelay","query","withCredentials","on","console","log","setTimeout","err","error","message","removeItem","navigate","onConnectionStatusChange","callback","disconnect","payload","JSON","parse","atob","split","exp","Date","now","_SocketService","socketService","connectSocket","refreshToken","response","fetch","method","credentials","ok","data","json","setItem","setConnectionStatus","status","statusElement","document","getElementById","warn","textContent","style","color"],"sources":["C:/Users/DELL/Documents/projects/suxch/chat-client/src/services/socket.ts"],"sourcesContent":["import { io, Socket } from 'socket.io-client';\nimport { useNavigate } from 'react-router-dom';\n\n\nclass SocketService {\n  private static instance: SocketService;\n  socket: Socket | null = null;\n\n  public static getInstance(): SocketService {\n    if (!SocketService.instance) {\n      SocketService.instance = new SocketService();\n    }\n    return SocketService.instance;\n  }\n\n  initializeSocket(token: string): Promise<Socket> {\n    return new Promise((resolve, reject) => {\n      if (this.socket?.connected) return resolve(this.socket);\n\n      const cleanToken = token.replace('Bearer ', '');\n      const userId = localStorage.getItem('userId');\n\n      if (!userId) {\n        return reject(new Error('Missing userId in localStorage'));\n      }\n\n      if (!this.isTokenValid(cleanToken)) {\n        return reject(new Error('Invalid or expired token'));\n      }\n\n      this.socket = io('http://localhost:8080', {\n        path: '/socket.io',\n        auth: { token: cleanToken },\n        transports: ['websocket'],\n        reconnectionAttempts: 5,\n        reconnectionDelay: 2000,\n        query: { userId, token: cleanToken },\n        withCredentials: true,\n      });\n\n      this.socket.on('connect', () => {\n        console.log(\"WebSocket connected\");\n        resolve(this.socket!);\n      });\n\n      this.socket.on('disconnect', () => {\n        console.log('Disconnected. Retrying...');\n        setTimeout(() => this.initializeSocket(token), 5000); // Retry after 5 seconds\n      });\n\n      this.socket.on('connect_error', (err) => {\n        console.error('Connection error:', err.message);\n        if (err.message === 'Unauthorized') {\n          localStorage.removeItem('token');\n          const navigate = useNavigate();\n          navigate('/login');\n        }\n        reject(err);\n      });\n    });\n  }\n\n  onConnectionStatusChange(callback: (status: 'connected' | 'disconnected' | 'error') => void) {\n    if (!this.socket) return;\n\n    this.socket.on('connect', () => callback('connected'));\n    this.socket.on('disconnect', () => callback('disconnected'));\n    this.socket.on('connect_error', () => callback('error'));\n    this.socket.on('reconnect_failed', () => callback('error'));\n  }\n\n  disconnect() {\n    if (this.socket) {\n      this.socket.disconnect();\n      this.socket = null;\n      console.log(\"üîå WebSocket disconnected\");\n    }\n  }\n\n  public isTokenValid(token: string): boolean {\n    try {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      return payload.exp * 1000 > Date.now(); // Check if token is expired\n    } catch {\n      return false;\n    }\n  }\n}\n\nexport const socketService = SocketService.getInstance();\n\nconst connectSocket = async () => {\n  let token = localStorage.getItem('token');\n  if (!token || !socketService.isTokenValid(token)) {\n    token = await refreshToken();\n\n    async function refreshToken(): Promise<string | null> {\n      // Example implementation of refreshToken\n      try {\n        const response = await fetch('http://localhost:8080/api/refresh-token', {\n          method: 'POST',\n          credentials: 'include',\n        });\n        if (!response.ok) throw new Error('Failed to refresh token');\n        const data = await response.json();\n        localStorage.setItem('token', data.token);\n        return data.token;\n      } catch (error) {\n        console.error('Error refreshing token:', error);\n        return null;\n      }\n    }\n    if (!token) {\n      navigate('/login');\n      return;\n    }\n  }\n\n  try {\n    const socket = await socketService.initializeSocket(token);\n    socketService.onConnectionStatusChange(setConnectionStatus);\n  } catch (error) {\n    console.error('Socket connection error:', error);\n    setConnectionStatus('error');\n  }\n};\nfunction setConnectionStatus(status: 'connected' | 'disconnected' | 'error'): void {\n  const statusElement = document.getElementById('connection-status');\n  if (!statusElement) {\n    console.warn('Connection status element not found in the DOM.');\n    return;\n  }\n\n  switch (status) {\n    case 'connected':\n      statusElement.textContent = 'üü¢ Connected';\n      statusElement.style.color = 'green';\n      break;\n    case 'disconnected':\n      statusElement.textContent = 'üî¥ Disconnected';\n      statusElement.style.color = 'red';\n      break;\n    case 'error':\n      statusElement.textContent = '‚ö†Ô∏è Connection Error';\n      statusElement.style.color = 'orange';\n      break;\n  }\n}\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}